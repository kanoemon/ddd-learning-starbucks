import {
  BeveragesController,
  CreateBeveragesRequest,
} from '../../../../controllers/products';
import {Sqlite3BeverageRepository} from '../../../../repositories';

const models = require('../../../../infrastructure/sequelize/models');

describe('BeveragesController(integration)', () => {
  afterEach(async () => {
    await models.BeveragePrice.destroy({
      truncate: true,
    });
    await models.Beverage.destroy({
      truncate: true,
    });
  });

  describe('create', () => {
    it('success', async () => {
      const controller = new BeveragesController(
        new Sqlite3BeverageRepository(),
      );
      const result = await controller.create(
        new CreateBeveragesRequest.Beverage('coffee', 'hot coffee', [
          new CreateBeveragesRequest.Price('short', 100),
        ]),
      );

      const foundBeverage = await models.Beverage.findByPk(result.id);

      expect(foundBeverage.name).toBe('coffee');
      expect(foundBeverage.explanation).toBe('hot coffee');
    });
  });

  describe('delete', () => {
    it('success', async () => {
      // create data
      await models.Beverage.create({
        name: 'coffee',
        explanation: 'hogehoge',
      });
      const targetBeverage = await models.Beverage.findOne({
        attributes: ['id'],
        where: {
          name: 'coffee',
        },
      });

      // test
      const controller = new BeveragesController(
        new Sqlite3BeverageRepository(),
      );
      await controller.remove(targetBeverage.dataValues.id);

      const foundBeverage = await models.Beverage.findByPk(
        targetBeverage.dataValues.id,
      );
      expect(foundBeverage.deleteFlg).toBe(true);
    });
  });

  describe('update', () => {
    it('name', async () => {
      // create data
      await models.Beverage.create({
        name: 'coffee',
        explanation: 'hogehoge',
      });
      const targetBeverage = await models.Beverage.findOne({
        attributes: ['id'],
        where: {
          name: 'coffee',
        },
      });

      // test
      const controller = new BeveragesController(
        new Sqlite3BeverageRepository(),
      );
      await controller.update(targetBeverage.dataValues.id, 'aaa');
    });
  });
});
